{{/* Find maintainers with succession plans for this project */}}
{{ $projectTitle := .Title }}
{{ $projectMaintainers := .Params.maintainers }}
{{ $plans := slice }}

{{/* Use project's maintainers list if available, otherwise fallback to reverse lookup */}}
{{ $maintainersToCheck := slice }}
{{ if $projectMaintainers }}
  {{ range $maintainerName := $projectMaintainers }}
    {{ $maintainerPage := $.Site.GetPage (printf "/maintainers/%s" (urlize $maintainerName)) }}
    {{ if not $maintainerPage }}
      {{ range where $.Site.RegularPages "Section" "maintainers" }}
        {{ if eq .Title $maintainerName }}
          {{ $maintainerPage = . }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ if $maintainerPage }}
      {{ $maintainersToCheck = $maintainersToCheck | append $maintainerPage }}
    {{ end }}
  {{ end }}
{{ else }}
  {{/* Fallback: reverse lookup from maintainer projects */}}
  {{ range $m := where .Site.RegularPages "Section" "maintainers" }}
    {{ if $m.Params.projects }}
      {{ range $p := $m.Params.projects }}
        {{ if eq $p $projectTitle }}
          {{ $maintainersToCheck = $maintainersToCheck | append $m }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{ range $m := $maintainersToCheck }}
  {{ $status := $m.Params.status | default "active" }}
  {{/* Support both single successor and multiple successors array */}}
  {{ if eq $status "active" }}
    {{/* Handle single successor (legacy format) */}}
    {{ if $m.Params.successor }}
      {{ $plans = $plans | append (dict "maintainer" $m "successor" $m.Params.successor) }}
    {{ end }}
    {{/* Handle multiple successors array */}}
    {{ if $m.Params.successors }}
      {{ range $s := $m.Params.successors }}
        {{ $plans = $plans | append (dict "maintainer" $m "successor" $s) }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if $plans }}
{{ $discussionId := printf "successors-%s" (urlize .Title) }}
<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin:20px 0;">
  <h3 style="margin:0 0 12px 0;font-size:1rem;color:#0f172a;">üõ°Ô∏è Potential Successors</h3>
  <p style="margin:0 0 12px 0;font-size:0.85rem;color:#64748b;">If {{ (index $plans 0).maintainer.Title }} steps down:</p>
  
  <div style="display:flex;flex-wrap:wrap;gap:8px;">
  {{ range $plans }}
    {{ $s := .successor }}
    {{ $successorPage := $.Site.GetPage (printf "/maintainers/%s" (urlize $s.name)) }}
    {{ if $successorPage }}
      <a href="{{ $successorPage.RelPermalink }}" style="display:flex;align-items:center;gap:8px;padding:6px 12px;background:#fff;border:1px solid #e2e8f0;border-radius:20px;text-decoration:none;transition:all 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#fff'">
        {{ $avatar := $successorPage.Params.avatar | default (printf "https://github.com/%s.png" ($successorPage.Params.links.github | default "")) }}
        <img src="{{ $avatar }}" alt="" style="width:24px;height:24px;border-radius:50%;object-fit:cover;" onerror="this.src='https://github.com/ghost.png'">
        <span style="font-size:0.875rem;color:#0f172a;font-weight:500;">{{ $s.name }}</span>
      </a>
    {{ else }}
      <span style="display:flex;align-items:center;gap:8px;padding:6px 12px;background:#fff;border:1px solid #e2e8f0;border-radius:20px;">
        <img src="https://github.com/ghost.png" alt="" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">
        <span style="font-size:0.875rem;color:#0f172a;font-weight:500;">{{ $s.name }}</span>
      </span>
    {{ end }}
  {{ end }}
  </div>
  
  <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;">
    <a href="https://github.com/zouyonghao/infrastructure-heroes/discussions?discussions_q={{ $discussionId }}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:6px;font-size:0.85rem;color:#059669;text-decoration:none;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2C6.48 2 2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V19c0-1.1.9-2 2-2h2.92c.54 0 1.08-.06 1.6-.18C16.84 17.06 17.96 17 19 17c.55 0 1-.45 1-1v-4c0-5.52-4.48-10-10-10zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
        <circle cx="9" cy="12" r="1.5"/>
        <circle cx="15" cy="12" r="1.5"/>
      </svg>
      Vote on GitHub Discussions
    </a>
  </div>
</div>
{{ end }}
