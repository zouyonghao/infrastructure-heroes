{{ $data := dict }}
{{ $filePath := "data/dependencies.json" }}
{{ if fileExists $filePath }}
  {{ $dataContent := readFile $filePath }}
  {{ $data = $dataContent | transform.Unmarshal }}
{{ end }}

{{ $chainName := .Get "chain" | default "The Modern Web Stack" }}
{{ $chain := dict }}

{{ if $data.chains }}
  {{ range $data.chains }}
    {{ if eq .name $chainName }}
      {{ $chain = . }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if $chain.name }}
<div class="dependency-chain xkcd-style">
  <h3 class="chain-title">{{ $chain.name }}</h3>
  <p class="chain-description">{{ $chain.description }}</p>
  
  <div class="chain-visualization">
    {{ range $index, $item := $chain.path }}
    <div class="chain-level level-{{ $item.level }}" data-level="{{ $item.level }}">
      <div class="level-connector">
        {{ if gt $item.level 0 }}
        <svg class="dependency-arrow" width="40" height="60" viewBox="0 0 40 60">
          <line x1="20" y1="0" x2="20" y2="50" stroke="#666" stroke-width="2" stroke-dasharray="5,3"/>
          <polygon points="15,45 20,55 25,45" fill="#666"/>
        </svg>
        {{ end }}
      </div>
      
      <div class="level-card {{ if ge $item.level 4 }}critical-foundation{{ end }}">
        <div class="level-header">
          <span class="level-number">L{{ $item.level }}</span>
          <span class="project-name">{{ $item.project }}</span>
        </div>
        
        <div class="level-details">
          <p class="project-description">{{ $item.description }}</p>
          
          {{ if $item.maintainer }}
          <div class="maintainer-info">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span class="maintainer-name">{{ $item.maintainer }}</span>
            {{ if $item.location }}
            <span class="maintainer-location">üìç {{ $item.location }}</span>
            {{ end }}
          </div>
          {{ end }}
          
          {{ if $item.note }}
          <div class="maintainer-note">
            <em>{{ $item.note }}</em>
          </div>
          {{ end }}
        </div>
        
        {{ if ge $item.level 4 }}
        <div class="risk-indicator">
          ‚ö†Ô∏è Critical Infrastructure
        </div>
        {{ end }}
      </div>
    </div>
    {{ end }}
  </div>
  
  {{ $chainPath := $chain.path }}
  {{ $criticalCount := 0 }}
  {{ range $chainPath }}
    {{ if ge .level 4 }}
      {{ $criticalCount = add $criticalCount 1 }}
    {{ end }}
  {{ end }}
  <div class="chain-insight">
    <p><strong>üí° The Reality:</strong> Your simple app depends on infrastructure maintained by 
    <strong>{{ $criticalCount }}</strong> critical projects, 
    some with single-digit maintainers, serving billions of users.</p>
  </div>
</div>
{{ else }}
<div class="dependency-chain-error">
  <p>Chain "{{ $chainName }}" not found. Available chains:</p>
  {{ if $data.chains }}
  <ul>
    {{ range $data.chains }}
    <li>{{ .name }}</li>
    {{ end }}
  </ul>
  {{ else }}
  <p><em>No chains configured in data/dependencies.json</em></p>
  {{ end }}
</div>
{{ end }}
