{{ $data := dict }}
{{ $filePath := "data/dependencies.json" }}
{{ if fileExists $filePath }}
  {{ $dataContent := readFile $filePath }}
  {{ $data = $dataContent | transform.Unmarshal }}
{{ end }}

{{ if $data.projects }}
<div class="dependency-explorer">
  <div class="explorer-header">
    <h2>ğŸ” Dependency Explorer</h2>
    <p>Discover the hidden infrastructure that powers modern software</p>
  </div>
  
  <div class="explorer-filters">
    <div class="filter-group">
      <label>View Mode:</label>
      <select id="dep-view-mode" class="filter-select">
        <option value="chains">Dependency Chains</option>
        <option value="network">Network Graph</option>
        <option value="foundations">Foundation Projects Only</option>
        <option value="at-risk">High Risk Projects</option>
      </select>
    </div>
    
    {{ if $data.chains }}
    <div class="filter-group">
      <label>Chain:</label>
      <select id="dep-chain-select" class="filter-select">
        {{ range $data.chains }}
        <option value="{{ .name }}">{{ .name }}</option>
        {{ end }}
      </select>
    </div>
    {{ end }}
  </div>
  
  <div class="explorer-content">
    <!-- Chains View -->
    <div id="view-chains" class="view-panel active">
      {{ if $data.chains }}
      {{ range $data.chains }}
      {{ $chainName := .name }}
      {{ $chainDesc := .description }}
      {{ $chainPath := .path }}
      <div class="dep-chain-card" data-chain="{{ $chainName }}">
        <h3>{{ $chainName }}</h3>
        <p>{{ $chainDesc }}</p>
        <div class="chain-preview">
          {{ range $index, $item := $chainPath }}
          {{ if lt $index 4 }}
          <span class="chain-node">{{ $item.project }}</span>
          {{ $chainPathLen := len $chainPath }}
          {{ if lt $index (sub $chainPathLen 1) }}
          <span class="chain-arrow">â†’</span>
          {{ end }}
          {{ end }}
          {{ end }}
          {{ $chainPathLen := len $chainPath }}
          {{ if gt $chainPathLen 4 }}
          <span class="chain-more">... +{{ sub $chainPathLen 4 }} more</span>
          {{ end }}
        </div>
        <div class="chain-stats">
          <span class="stat">
            <strong>{{ len $chainPath }}</strong> levels deep
          </span>
          {{ $criticalCount := 0 }}
          {{ range $chainPath }}
            {{ if ge .level 4 }}
              {{ $criticalCount = add $criticalCount 1 }}
            {{ end }}
          {{ end }}
          <span class="stat">
            <strong>{{ $criticalCount }}</strong> critical
          </span>
        </div>
      </div>
      {{ end }}
      {{ else }}
      <p>No dependency chains configured.</p>
      {{ end }}
    </div>
    
    <!-- Network View -->
    <div id="view-network" class="view-panel">
      <div class="network-legend">
        <div class="legend-item">
          <span class="legend-dot foundation"></span>
          Foundation (no deps)
        </div>
        <div class="legend-item">
          <span class="legend-dot infrastructure"></span>
          Infrastructure
        </div>
        <div class="legend-item">
          <span class="legend-dot high-risk"></span>
          High Bus Factor Risk
        </div>
      </div>
      
      <div class="project-network">
        {{ range $slug, $project := $data.projects }}
        {{ $dependedBy := $project.depended_by | default slice }}
        <div class="network-node 
          {{ if $project.is_foundation }}foundation{{ end }}
          {{ if eq $project.bus_factor "high" }}high-risk{{ end }}"
          data-project="{{ $slug }}"
          data-dependents="{{ len $dependedBy }}">
          <div class="node-header">
            <span class="node-name">{{ $project.name }}</span>
            {{ if $project.is_foundation }}
            <span class="node-badge foundation">ğŸ›ï¸</span>
            {{ end }}
            {{ if eq $project.bus_factor "high" }}
            <span class="node-badge risk">âš ï¸</span>
            {{ end }}
          </div>
          <div class="node-meta">
            {{ $healthScore := $project.health_score | default 50 }}
            <span class="health-score {{ if ge $healthScore 80 }}good{{ else if ge $healthScore 60 }}warn{{ else }}bad{{ end }}">
              {{ $healthScore }}
            </span>
            <span class="dependents-count" title="Depended on by {{ len $dependedBy }} projects">
              ğŸ“¦ {{ len $dependedBy }}
            </span>
          </div>
          <div class="node-maintainer">
            {{ if $project.maintainer_location }}ğŸ“ {{ $project.maintainer_location }}
            {{ else }}ğŸ‘¤ {{ $project.maintainer }}{{ end }}
          </div>
        </div>
        {{ end }}
      </div>
    </div>
    
    <!-- Foundations View -->
    <div id="view-foundations" class="view-panel">
      <div class="foundations-grid">
        {{ range $slug, $project := $data.projects }}
        {{ if $project.is_foundation }}
        {{ $dependedBy := $project.depended_by | default slice }}
        <div class="foundation-card">
          <div class="foundation-header">
            <h3>{{ $project.name }}</h3>
            <span class="load-bearing-badge">ğŸ—ï¸ Load Bearing</span>
          </div>
          <p>{{ $project.description }}</p>
          <div class="foundation-stats">
            <div class="stat">
              <span class="stat-value">{{ len $dependedBy }}</span>
              <span class="stat-label">Projects depend on this</span>
            </div>
            <div class="stat">
              <span class="stat-value">{{ $project.direct_users | default "Unknown" }}</span>
              <span class="stat-label">Direct users</span>
            </div>
          </div>
          <div class="foundation-maintainer">
            <strong>Maintainer:</strong> {{ $project.maintainer }}
            {{ if $project.maintainer_location }}
            <span class="location">({{ $project.maintainer_location }})</span>
            {{ end }}
          </div>
          <div class="foundation-risk">
            Bus Factor: 
            <span class="risk-level {{ $project.bus_factor }}">
              {{ $project.bus_factor }}
            </span>
          </div>
        </div>
        {{ end }}
        {{ end }}
      </div>
    </div>
    
    <!-- At Risk View -->
    <div id="view-at-risk" class="view-panel">
      <div class="risk-intro">
        <h3>âš ï¸ Critical Infrastructure at Risk</h3>
        <p>These foundational projects have high bus factor or are maintained by very small teams.</p>
      </div>
      
      <div class="risk-list">
        {{ range $slug, $project := $data.projects }}
        {{ if or (eq $project.bus_factor "high") (eq $project.bus_factor "medium") }}
        {{ $dependedBy := $project.depended_by | default slice }}
        <div class="risk-card {{ $project.bus_factor }}">
          <div class="risk-header">
            <h4>{{ $project.name }}</h4>
            <span class="risk-badge {{ $project.bus_factor }}">
              {{ if eq $project.bus_factor "high" }}ğŸ”´ High Risk
              {{ else }}ğŸŸ¡ Medium Risk{{ end }}
            </span>
          </div>
          <p class="risk-description">{{ $project.description }}</p>
          <div class="risk-impact">
            <strong>Impact if lost:</strong> {{ $project.direct_users | default "Unknown" }} affected
          </div>
          <div class="risk-maintainer">
            <div class="maintainer-avatar">
              {{ if $project.maintainer_location }}ğŸ“{{ else }}ğŸ‘¤{{ end }}
            </div>
            <div class="maintainer-details">
              <strong>{{ $project.maintainer }}</strong>
              {{ if $project.maintainer_location }}
              <span>{{ $project.maintainer_location }}</span>
              {{ end }}
            </div>
          </div>
          <div class="risk-dependents">
            <strong>{{ len $dependedBy }}</strong> projects directly depend on this
          </div>
          <div class="risk-actions">
            <a href="/projects/{{ $slug }}/" class="btn btn-sm">View Project</a>
          </div>
        </div>
        {{ end }}
        {{ end }}
      </div>
    </div>
  </div>
  
  <!-- Statistics Panel -->
  {{ if $data.statistics }}
  <div class="explorer-stats">
    <h4>ğŸ“Š Infrastructure Statistics</h4>
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-number">{{ $data.statistics.total_foundation_projects | default 0 }}</span>
        <span class="stat-label">Foundation Projects</span>
        <span class="stat-hint">No dependencies, everything depends on them</span>
      </div>
      <div class="stat-card">
        <span class="stat-number">{{ $data.statistics.single_maintainer_projects | default 0 }}</span>
        <span class="stat-label">Single-Maintainer Projects</span>
        <span class="stat-hint">Single points of failure</span>
      </div>
      <div class="stat-card">
        <span class="stat-number">{{ $data.statistics.high_bus_factor_risk | default 0 }}</span>
        <span class="stat-label">High Bus Factor Risk</span>
        <span class="stat-hint">Small teams, huge impact</span>
      </div>
      <div class="stat-card">
        {{ $projectCount := 0 }}
        {{ range $data.projects }}
          {{ $projectCount = add $projectCount 1 }}
        {{ end }}
        <span class="stat-number">{{ $projectCount }}</span>
        <span class="stat-label">Projects Tracked</span>
        <span class="stat-hint">In the dependency graph</span>
      </div>
    </div>
    
    {{ if $data.statistics.most_depended_upon }}
    <div class="most-depended">
      <h5>ğŸ† Most Depended Upon</h5>
      <ol>
        {{ range $data.statistics.most_depended_upon }}
        <li>
          <strong>{{ .project }}</strong>
          <span class="dependents-bar">
            <span class="bar" style="width: {{ mul (div .dependents 15.0) 100 }}%"></span>
            <span class="count">{{ .dependents }} dependents</span>
          </span>
        </li>
        {{ end }}
      </ol>
    </div>
    {{ end }}
  </div>
  {{ end }}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const viewMode = document.getElementById('dep-view-mode');
  const panels = document.querySelectorAll('.view-panel');
  const chainSelect = document.getElementById('dep-chain-select');
  
  viewMode?.addEventListener('change', function() {
    const mode = this.value;
    panels.forEach(p => p.classList.remove('active'));
    document.getElementById('view-' + mode)?.classList.add('active');
    
    // Show/hide chain selector
    if (chainSelect) {
      chainSelect.parentElement.style.display = mode === 'chains' ? 'block' : 'none';
    }
  });
  
  // Chain card click to expand
  document.querySelectorAll('.dep-chain-card').forEach(card => {
    card.addEventListener('click', function() {
      const chainName = this.dataset.chain;
      if (chainSelect) {
        chainSelect.value = chainName;
      }
    });
  });
  
  // Network node hover effects
  document.querySelectorAll('.network-node').forEach(node => {
    node.addEventListener('mouseenter', function() {
      const project = this.dataset.project;
      // Could highlight connections here
    });
  });
});
</script>
{{ else }}
<div class="dependency-explorer-error">
  <p>âš ï¸ Could not load dependency data. Please check that <code>data/dependencies.json</code> exists and is valid JSON.</p>
</div>
{{ end }}
