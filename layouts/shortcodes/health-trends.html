{{ $dataDir := "data/historical" }}
{{ $summaryFile := printf "%s/summary.json" $dataDir }}

{{ if fileExists $summaryFile }}
    {{ $summaryContent := readFile $summaryFile }}
    {{ $summary := $summaryContent | transform.Unmarshal }}
    
    <div class="health-trends-section">
        <h3>ðŸ“ˆ Historical Trends</h3>
        
        <div class="trends-summary">
            <div class="trend-stat">
                <span class="trend-value">{{ $summary.total_snapshots | default 0 }}</span>
                <span class="trend-label">Data Points</span>
            </div>
            <div class="trend-stat">
                {{ $fromDate := $summary.date_range.from | default "N/A" }}
                {{ $toDate := $summary.date_range.to | default "N/A" }}
                <span class="trend-value">{{ $fromDate }} to {{ $toDate }}</span>
                <span class="trend-label">Date Range</span>
            </div>
        </div>
        
        {{ if $summary.trends }}
        <div class="trends-charts">
            {{ if $summary.trends.avg_score_over_time }}
            {{ $avgScores := $summary.trends.avg_score_over_time }}
            {{ $lastIndex := sub (len $avgScores) 1 }}
            {{ $currentValue := (index $avgScores $lastIndex).value | default 0 }}
            {{ $previousValue := 0 }}
            {{ if ge $lastIndex 1 }}{{ $previousValue = (index $avgScores (sub $lastIndex 1)).value | default 0 }}{{ end }}
            <div class="trend-chart">
                <h4>Average Health Score</h4>
                <div class="sparkline" data-values="{{ range $avgScores }}{{ .value }},{{ end }}" data-type="line"></div>
                <div class="trend-current">
                    Current: <strong>{{ $currentValue | math.Round }} / 100</strong>
                    <span class="trend-indicator" data-current="{{ $currentValue }}" data-previous="{{ $previousValue }}"></span>
                </div>
            </div>
            {{ end }}
            
            {{ if $summary.trends.critical_count_over_time }}
            {{ $criticalCounts := $summary.trends.critical_count_over_time }}
            {{ $lastIndex := sub (len $criticalCounts) 1 }}
            {{ $currentCount := (index $criticalCounts $lastIndex).value | default 0 }}
            {{ $previousCount := 0 }}
            {{ if ge $lastIndex 1 }}{{ $previousCount = (index $criticalCounts (sub $lastIndex 1)).value | default 0 }}{{ end }}
            <div class="trend-chart">
                <h4>Critical Projects</h4>
                <div class="sparkline critical" data-values="{{ range $criticalCounts }}{{ .value }},{{ end }}"></div>
                <div class="trend-current">
                    Current: <strong class="text-danger">{{ $currentCount }}</strong> projects
                    {{ if ne $currentCount $previousCount }}
                    <span class="trend-indicator" data-current="{{ $currentCount }}" data-previous="{{ $previousCount }}"></span>
                    {{ end }}
                </div>
            </div>
            {{ end }}
            
            {{ if $summary.trends.score_distribution }}
            <div class="trend-chart">
                <h4>Score Distribution</h4>
                {{ $dist := $summary.trends.score_distribution }}
                <div class="score-distribution">
                    <div class="dist-item healthy">
                        <span class="dist-label">Healthy (80+)</span>
                        <span class="dist-value">{{ $dist.healthy | default 0 }}</span>
                    </div>
                    <div class="dist-item warning">
                        <span class="dist-label">Warning (60-79)</span>
                        <span class="dist-value">{{ $dist.warning | default 0 }}</span>
                    </div>
                    <div class="dist-item critical">
                        <span class="dist-label">Critical (<60)</span>
                        <span class="dist-value">{{ $dist.critical | default 0 }}</span>
                    </div>
                </div>
            </div>
            {{ end }}
        </div>
        {{ end }}
    </div>
{{ else }}
    <div class="health-trends-empty">
        <p><em>Trend data will be available after the first automated metrics collection.</em></p>
    </div>
{{ end }}
