<div class="projects-filter">
    <div class="filter-row">
        <div class="filter-search">
            <svg class="filter-search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" id="project-search" placeholder="Search projects by name or description..." class="filter-input">
            <button id="clear-search" class="filter-clear" title="Clear search" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <select id="health-filter" class="filter-select">
            <option value="">All Health Status</option>
            <option value="critical">ðŸ”´ Critical (0-59)</option>
            <option value="warning">ðŸŸ¡ Warning (60-79)</option>
            <option value="healthy">ðŸŸ¢ Healthy (80-100)</option>
        </select>

        <select id="sort-by" class="filter-select">
            <option value="score-desc">Score: High to Low</option>
            <option value="score-asc">Score: Low to High</option>
            <option value="name-asc">Name: A to Z</option>
            <option value="name-desc">Name: Z to A</option>
        </select>

        <button id="reset-filters" class="filter-reset">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"></path>
                <path d="M3 3v9h9"></path>
            </svg>
            Reset
        </button>
    </div>

    <div class="filter-stats">
        <span id="filter-results">Showing <strong id="visible-count">{{ len (where .Site.RegularPages "Section" "projects") }}</strong> projects</span>
        <span id="active-filters" class="active-filters" style="display: none;"></span>
    </div>
</div>

<div id="no-results" class="no-results" style="display: none;">
    <div class="no-results-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
            <line x1="8" y1="8" x2="14" y2="14"></line>
            <line x1="14" y1="8" x2="8" y2="14"></line>
        </svg>
    </div>
    <h3>No projects found</h3>
    <p>Try adjusting your search or filters to find what you're looking for.</p>
    <button id="no-results-reset" class="btn btn-secondary">Clear all filters</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    'use strict';
    
    // Elements
    const searchInput = document.getElementById('project-search');
    const healthFilter = document.getElementById('health-filter');
    const sortBy = document.getElementById('sort-by');
    const resetBtn = document.getElementById('reset-filters');
    const clearSearchBtn = document.getElementById('clear-search');
    const visibleCount = document.getElementById('visible-count');
    const filterResults = document.getElementById('filter-results');
    const activeFiltersEl = document.getElementById('active-filters');
    const noResults = document.getElementById('no-results');
    const noResultsReset = document.getElementById('no-results-reset');
    const projectsGrid = document.querySelector('.projects-grid');
    
    // Get all project cards
    let projectCards = Array.from(document.querySelectorAll('.project-card'));
    
    // Store original order
    const originalOrder = projectCards.map(card => ({
        card: card,
        parent: card.parentNode,
        title: card.querySelector('.project-title')?.textContent?.toLowerCase() || '',
        score: parseInt(card.querySelector('.score-number')?.textContent || '0'),
        health: card.dataset.health || ''
    }));
    
    // Debounce function for search
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Update active filters display
    function updateActiveFilters() {
        const filters = [];
        
        if (searchInput.value.trim()) {
            filters.push(`Search: "${searchInput.value.trim()}"`);
        }
        
        if (healthFilter.value) {
            const healthText = healthFilter.options[healthFilter.selectedIndex].text.split(' ')[1];
            filters.push(`Status: ${healthText}`);
        }
        
        if (filters.length > 0) {
            activeFiltersEl.innerHTML = ' â€¢ Filtered by: ' + filters.join(', ');
            activeFiltersEl.style.display = 'inline';
        } else {
            activeFiltersEl.style.display = 'none';
        }
    }
    
    // Sort projects
    function sortProjects(cards, sortValue) {
        const sorted = [...cards];
        
        switch(sortValue) {
            case 'score-desc':
                sorted.sort((a, b) => {
                    const scoreA = parseInt(a.querySelector('.score-number')?.textContent || '0');
                    const scoreB = parseInt(b.querySelector('.score-number')?.textContent || '0');
                    return scoreB - scoreA;
                });
                break;
            case 'score-asc':
                sorted.sort((a, b) => {
                    const scoreA = parseInt(a.querySelector('.score-number')?.textContent || '0');
                    const scoreB = parseInt(b.querySelector('.score-number')?.textContent || '0');
                    return scoreA - scoreB;
                });
                break;
            case 'name-asc':
                sorted.sort((a, b) => {
                    const titleA = a.querySelector('.project-title')?.textContent?.toLowerCase() || '';
                    const titleB = b.querySelector('.project-title')?.textContent?.toLowerCase() || '';
                    return titleA.localeCompare(titleB);
                });
                break;
            case 'name-desc':
                sorted.sort((a, b) => {
                    const titleA = a.querySelector('.project-title')?.textContent?.toLowerCase() || '';
                    const titleB = b.querySelector('.project-title')?.textContent?.toLowerCase() || '';
                    return titleB.localeCompare(titleA);
                });
                break;
        }
        
        // Re-append in sorted order
        const parent = projectsGrid;
        sorted.forEach(item => {
            if (item.style.display !== 'none') {
                parent.appendChild(item);
            }
        });
    }
    
    // Filter projects
    function filterProjects() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const healthValue = healthFilter.value;
        const sortValue = sortBy.value;
        let visible = 0;
        
        // Show/hide clear search button
        clearSearchBtn.style.display = searchTerm ? 'flex' : 'none';
        
        projectCards.forEach(card => {
            const title = card.querySelector('.project-title')?.textContent?.toLowerCase() || '';
            const description = card.querySelector('.project-description')?.textContent?.toLowerCase() || '';
            const cardHealth = card.dataset.health || '';
            
            const matchesSearch = !searchTerm || title.includes(searchTerm) || description.includes(searchTerm);
            const matchesHealth = !healthValue || cardHealth === healthValue;
            
            if (matchesSearch && matchesHealth) {
                card.style.display = '';
                visible++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Sort visible projects
        sortProjects(projectCards, sortValue);
        
        // Update UI
        visibleCount.textContent = visible;
        updateActiveFilters();
        
        // Show/hide no results message
        if (visible === 0) {
            projectsGrid.style.display = 'none';
            noResults.style.display = 'block';
            filterResults.innerHTML = 'No projects match your filters';
        } else {
            projectsGrid.style.display = 'grid';
            noResults.style.display = 'none';
            filterResults.innerHTML = `Showing <strong id="visible-count">${visible}</strong> ${visible === 1 ? 'project' : 'projects'}`;
        }
        
        // Store filters in URL hash for persistence
        updateUrlHash();
    }
    
    // Update URL hash with current filters
    function updateUrlHash() {
        const params = new URLSearchParams();
        
        if (searchInput.value.trim()) {
            params.set('search', searchInput.value.trim());
        }
        
        if (healthFilter.value) {
            params.set('health', healthFilter.value);
        }
        
        if (sortBy.value !== 'score-desc') {
            params.set('sort', sortBy.value);
        }
        
        const hash = params.toString();
        if (hash) {
            history.replaceState(null, null, '#' + hash);
        } else {
            history.replaceState(null, null, window.location.pathname + window.location.search);
        }
    }
    
    // Load filters from URL hash
    function loadFiltersFromHash() {
        const hash = window.location.hash.slice(1);
        if (!hash) return;
        
        const params = new URLSearchParams(hash);
        
        if (params.has('search')) {
            searchInput.value = params.get('search');
        }
        
        if (params.has('health')) {
            healthFilter.value = params.get('health');
        }
        
        if (params.has('sort')) {
            sortBy.value = params.get('sort');
        }
        
        filterProjects();
    }
    
    // Event listeners
    const debouncedFilter = debounce(filterProjects, 150);
    
    searchInput?.addEventListener('input', debouncedFilter);
    healthFilter?.addEventListener('change', filterProjects);
    sortBy?.addEventListener('change', filterProjects);
    
    clearSearchBtn?.addEventListener('click', function() {
        searchInput.value = '';
        searchInput.focus();
        filterProjects();
    });
    
    function resetAllFilters() {
        searchInput.value = '';
        healthFilter.value = '';
        sortBy.value = 'score-desc';
        clearSearchBtn.style.display = 'none';
        filterProjects();
    }
    
    resetBtn?.addEventListener('click', resetAllFilters);
    noResultsReset?.addEventListener('click', resetAllFilters);
    
    // Load filters on page load
    loadFiltersFromHash();
    
    // Handle hash changes
    window.addEventListener('hashchange', loadFiltersFromHash);
});
</script>
