{{ $projects := where .Site.RegularPages "Section" "projects" }}
{{ $limit := .Get "limit" | default 0 }}
{{ $sortedProjects := $projects.ByParam "health.score" }}
{{ $sortedProjects = $sortedProjects.Reverse }}
{{ if gt $limit 0 }}
    {{ $sortedProjects = first $limit $sortedProjects }}
{{ end }}
<div class="projects-grid">
    {{ range $sortedProjects }}
    <div class="project-card" data-health="{{ if ge .Params.health.score 80 }}healthy{{ else if ge .Params.health.score 60 }}warning{{ else }}critical{{ end }}">
        <div class="project-header">
            {{ if .Params.logo }}
            <div class="project-logo">
                <img src="{{ .Params.logo }}" alt="{{ .Title }} logo" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="logo-fallback" style="display: none;">
                    <span>{{ substr .Title 0 1 }}</span>
                </div>
            </div>
            {{ end }}
            <div class="project-info">
                <h3 class="project-title"><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
                {{ if .Params.description }}
                <p class="project-description">{{ .Params.description }}</p>
                {{ end }}
            </div>
        </div>

        {{ if .Params.health }}
        <div class="health-indicator">
            <div class="health-score-display">
                <div class="health-score-circle {{ if ge .Params.health.score 80 }}healthy{{ else if ge .Params.health.score 60 }}warning{{ else }}critical{{ end }}">
                    <span class="score-number">{{ .Params.health.score }}</span>
                </div>
                <span class="health-score-label">Health Score</span>
            </div>
            <div class="health-metrics">
                <div class="health-metric {{ if eq .Params.health.funding "stable" }}good{{ else if eq .Params.health.funding "at-risk" }}medium{{ else }}bad{{ end }}">
                    <span class="metric-label">Funding</span>
                    <span class="metric-value">{{ .Params.health.funding }}</span>
                </div>
                <div class="health-metric {{ if eq .Params.health.maintenance "active" }}good{{ else if eq .Params.health.maintenance "moderate" }}medium{{ else }}bad{{ end }}">
                    <span class="metric-label">Maintenance</span>
                    <span class="metric-value">{{ .Params.health.maintenance }}</span>
                </div>
                <div class="health-metric {{ if eq .Params.health.contributors "healthy" }}good{{ else if eq .Params.health.contributors "declining" }}medium{{ else }}bad{{ end }}">
                    <span class="metric-label">Contributors</span>
                    <span class="metric-value">{{ .Params.health.contributors }}</span>
                </div>
                <div class="health-metric {{ if eq .Params.health.bus_factor "low" }}good{{ else if eq .Params.health.bus_factor "medium" }}medium{{ else }}bad{{ end }}">
                    <span class="metric-label">Bus Factor</span>
                    <span class="metric-value">{{ .Params.health.bus_factor }}</span>
                </div>
            </div>
        </div>
        {{ end }}
        
        {{ if .Params.metrics.updated_at }}
        <div class="project-meta">
            <span class="last-updated" title="Last metrics update: {{ .Params.metrics.updated_at }}">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                {{ $updatedDate := time .Params.metrics.updated_at }}
                {{ $daysAgo := div (sub now.Unix $updatedDate.Unix) 86400 }}
                {{ if eq $daysAgo 0 }}
                    Updated today
                {{ else if eq $daysAgo 1 }}
                    Updated yesterday
                {{ else if lt $daysAgo 30 }}
                    Updated {{ $daysAgo }} days ago
                {{ else if lt $daysAgo 60 }}
                    Updated 1 month ago
                {{ else }}
                    Updated {{ div $daysAgo 30 }} months ago
                {{ end }}
            </span>
        </div>
        {{ end }}
    </div>
    {{ end }}
</div>
