{{ $projects := where .Site.RegularPages "Section" "projects" }}
{{ $limit := .Get "limit" | default 0 }}
{{ $sortedProjects := $projects.ByParam "health.score" }}
{{ $sortedProjects = $sortedProjects.Reverse }}
{{ if gt $limit 0 }}
    {{ $sortedProjects = first $limit $sortedProjects }}
{{ end }}
<div class="projects-grid">
    {{ range $sortedProjects }}
    <div class="project-card" data-health="{{ if ge .Params.health.score 80 }}healthy{{ else if ge .Params.health.score 60 }}warning{{ else }}critical{{ end }}">
        <div class="project-header">
            {{ if .Params.logo }}
            <div class="project-logo">
                <img src="{{ .Params.logo }}" alt="{{ .Title }} logo" loading="lazy">
            </div>
            {{ end }}
            <div class="project-info">
                <h3 class="project-title"><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
                {{ if .Params.description }}
                <p class="project-description">{{ .Params.description }}</p>
                {{ end }}
            </div>
        </div>

        {{ if .Params.health }}
        <div class="health-indicator">
            <div class="health-score-display">
                <div class="health-score-circle {{ if ge .Params.health.score 80 }}healthy{{ else if ge .Params.health.score 60 }}warning{{ else }}critical{{ end }}">
                    <span class="score-number">{{ .Params.health.score }}</span>
                </div>
                <span class="health-score-label">Health Score</span>
            </div>
            <div class="health-metrics">
                <div class="health-metric {{ if eq .Params.health.funding "stable" }}good{{ else if eq .Params.health.funding "at-risk" }}medium{{ else }}bad{{ end }}">
                    <span class="metric-label">Funding</span>
                    <span class="metric-value">{{ .Params.health.funding }}</span>
                </div>
                <div class="health-metric {{ if eq .Params.health.maintenance "active" }}good{{ else if eq .Params.health.maintenance "moderate" }}medium{{ else }}bad{{ end }}">
                    <span class="metric-label">Maintenance</span>
                    <span class="metric-value">{{ .Params.health.maintenance }}</span>
                </div>
                <div class="health-metric {{ if eq .Params.health.contributors "healthy" }}good{{ else if eq .Params.health.contributors "declining" }}medium{{ else }}bad{{ end }}">
                    <span class="metric-label">Contributors</span>
                    <span class="metric-value">{{ .Params.health.contributors }}</span>
                </div>
                <div class="health-metric {{ if eq .Params.health.bus_factor "low" }}good{{ else if eq .Params.health.bus_factor "medium" }}medium{{ else }}bad{{ end }}">
                    <span class="metric-label">Bus Factor</span>
                    <span class="metric-value">{{ .Params.health.bus_factor }}</span>
                </div>
            </div>
        </div>
        {{ end }}
    </div>
    {{ end }}
</div>
